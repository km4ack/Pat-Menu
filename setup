#!/bin/bash

#script to setup patmenu system after downloaded

#20191117 KM4ACK

if ! hash yad 2>/dev/null; then
    sudo apt install -y yad
fi

#set notepad editor based on release
VERSION=$(cat /etc/os-release | grep VERSION_ID | sed 's/VERSION_ID="//' | sed 's/"//')
echo $VERSION
if [ $VERSION == '9' ]
then
EDITOR=leafpad
elif [ $VERSION == '10' ]
then
EDITOR=mousepad
fi

cd $HOME/patmenu

chmod +x autopat catalog findardop getardoplist patlogin patmenu-new start-pat2m start-pat-ardop stop-modems uninstall update auto-download


#check if evince is installed
EVINCE=$(dpkg --get-selections | grep -w "evince")
if [ -z "$EVINCE" ]
then
sudo apt-get install -y evince
else
echo "evince is already installed"
fi

#check to see if ardop list exist. get if needed.
if [ -f $HOME/patmenu/ardop-list/ardoplist.txt ]
then
    echo "ARDOP list exist. No need to download"
else
#run initial getardoplist
echo "Please wait while the latest"
echo "Gateway list is downloaded"
$HOME/patmenu/getardoplist
fi

#create symlink on desktop

#remove old style symlink
SYM=$(ls $HOME/Desktop/ | grep Pat-Menu)
if [ -z "$SYM" ]
then
echo
else
rm $HOME/Desktop/Pat-Menu
fi

#check if new link already exists & create if needed
NEWSYM=$(ls $HOME/Desktop/pat-menu.desktop)
if [ -z "$NEWSYM" ]
then
SC=$HOME/Desktop/pat-menu.desktop
sudo ln -sf $HOME/patmenu/patmenu-new /usr/local/bin/patmenu
touch $SC
echo "[Desktop Entry]" >> $SC
echo "Name=Pat Menu" >> $SC
echo "Comment=Pat Winlink Menu by KM4ACK" >> $SC
echo "Exec=patmenu" >> $SC
echo "Icon=" >> $SC
echo "Terminal=true" >> $SC
echo "Type=Application" >> $SC
echo "Categories=AudioVideo;HamRadio;" >> $SC
fi


#remove a few files
rm $HOME/patmenu/README.md
rm $HOME/patmenu/patsetup
rm $HOME/patmenu/setup

echo "#########################################"
echo "#      Please see config file before    #"
echo "#      running Pat Menu. There is a     #"
echo "#      new icon on the desktop to start #"
echo "#      the new menu system. Double      #"
echo "#      click the icon and choose        #"
echo "#      "execute in terminal"            #"
echo "#########################################"

$EDITOR $HOME/patmenu/readme &
